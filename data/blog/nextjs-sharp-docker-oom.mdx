---
title: 'Next.js Image Optimization Crashes Docker with OOM? Install Sharp'
date: '2026-02-18'
tags: ['nextjs', 'docker', 'til', 'devops']
draft: false
summary: 'How a missing sharp package caused repeated OOM kills in production and how to fix it.'
---

## The Problem

After deploying my Next.js blog to a VPS (2 cores, 2GB RAM) with Docker, I noticed that most images on the site were broken. Only the smallest images (under ~60KB) loaded, while larger ones caused the page to hang.

Checking the container logs revealed the culprit:

```
⚠ For production Image Optimization with Next.js, the optional 'sharp' package
  is strongly recommended. Run 'npm i sharp', and Next.js will use it
  automatically for Image Optimization.
error Command failed with signal "SIGKILL".
```

The container was getting **OOM killed** every time someone requested a larger image.

## Why This Happens

Without `sharp`, Next.js falls back to a pure JavaScript image optimizer called `squoosh`. While it works, it's extremely memory-hungry — especially with large source images. In my case, one of my project screenshots was **12,276 x 4,042 pixels**. When the JS optimizer tried to decode, resize, and re-encode that image, it consumed all available memory and the kernel killed the process (`SIGKILL`).

The small images (like a 5.6KB WebP file) processed fine because they didn't push memory over the limit. This made the bug confusing — some images worked, some didn't, and it worked perfectly on my local machine (which has plenty of RAM).

## The Fix

Install [`sharp`](https://sharp.pixelplumbing.com/) in your Docker image. Sharp uses native `libvips` bindings, which are far more memory-efficient than the JS fallback.

In my Dockerfile, I added it to the dependency installation step:

```dockerfile
# Install dependencies + sharp for production image optimization
RUN yarn install && yarn add sharp --ignore-engines
```

That's it. Next.js automatically detects `sharp` and uses it instead of the JS fallback.

## Key Takeaways

- **Always install `sharp` in production Next.js Docker images.** The JS fallback is fine for development but can OOM on memory-constrained servers.
- **`SIGKILL` in Docker logs usually means OOM.** The kernel killed the process because it exceeded memory limits.
- **Large source images amplify the problem.** A 12K-wide PNG might only be 132KB on disk, but decoding it into raw pixels takes hundreds of megabytes of RAM.
- **Test with production-sized images locally** — if your dev machine has 32GB RAM, you won't catch memory issues that appear on a 2GB VPS.
